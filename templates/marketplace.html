<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marketplace Jobs | Professional Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    .skill-tag {
      display: inline-flex;
      align-items: center;
      border: 1px solid #cbd5e1;
      border-radius: 9999px;
      padding: 4px 10px;
      font-size: 13px;
      color: #334155;
      margin: 4px;
      background-color: #f8fafc;
      transition: all 0.2s ease;
    }
    .skill-tag:hover { 
      background-color: #e2e8f0; 
      transform: translateY(-1px);
    }
    
    .drawer { transition: transform 0.3s ease-in-out; }
    
    .job-card {
      transition: all 0.2s ease;
      border-left: 4px solid transparent;
    }
    .job-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-left-color: #6366f1;
    }
    
    .loading-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 0.5rem;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .search-input {
      transition: all 0.2s ease;
    }
    .search-input:focus {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      border-color: #6366f1;
    }
    
    .stats-badge {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 12px;
    }
    
    .salary-badge {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 12px;
    }
    
    .filter-chip {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .filter-chip:hover { background: #e5e7eb; }
    .filter-chip.active { 
      background: #6366f1; 
      color: white; 
      border-color: #6366f1; 
    }
    
    /* Enhanced job description formatting */
    .job-description {
      line-height: 1.6;
    }
    
    .job-description .section-header {
      font-weight: 600;
      color: #1f2937;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    
    .job-description .bullet-point {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .job-description .bullet-icon {
      color: #6366f1;
      font-weight: bold;
      margin-top: 0.125rem;
      flex-shrink: 0;
    }
    
    .form-input {
      transition: all 0.2s ease;
      border: 2px solid #e5e7eb;
    }
    .form-input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      outline: none;
    }
    
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex min-h-screen">
    <!-- Sidebar - Fixed -->
    <aside class="fixed left-0 top-0 h-full w-64 bg-gray-900 text-gray-100 flex flex-col p-6 space-y-6 z-40 overflow-y-auto">
      <div class="flex items-center gap-2 text-xl font-semibold">
        <i data-lucide="briefcase" class="w-5 h-5"></i>
        <span>Job Portal</span>
      </div>
      <nav class="flex flex-col space-y-2 text-sm font-medium">
        <a href="#" class="flex items-center gap-2 px-3 py-2 rounded bg-gray-800">
          <i data-lucide="layout-list" class="w-4 h-4"></i> Marketplace Jobs
        </a>
        <a href="/scraper" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-gray-800">
          <i data-lucide="search" class="w-4 h-4"></i> Scraper
        </a>
      </nav>
      
      <!-- Quick Stats in Sidebar -->
      <div class="mt-8 pt-6 border-t border-gray-700">
        <h3 class="text-sm font-semibold text-gray-300 mb-3">Quick Stats</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-400">Total Jobs:</span>
            <span id="sidebarTotal" class="text-white font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-400">Companies:</span>
            <span id="sidebarCompanies" class="text-white font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-400">With Salary:</span>
            <span id="sidebarSalary" class="text-white font-medium">--</span>
          </div>
        </div>
      </div>


    </aside>

    <!-- Main content - Scrollable with left margin to account for fixed sidebar -->
    <main class="flex-1 ml-64 h-screen overflow-y-auto">
      <div class="p-10">
      <!-- Header with Search -->
      <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 gap-4">
        <h1 class="text-2xl font-semibold text-gray-900 flex items-center gap-2">
          <i data-lucide="layout-list" class="w-5 h-5"></i> Marketplace Jobs
        </h1>
        
        <!-- Search and Filters -->
        <div class="flex items-center gap-3">
          <div class="relative">
            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
            <input 
              type="text" 
              id="searchInput"
              placeholder="Search jobs, companies, skills..."
              class="search-input pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none w-64"
            >
          </div>
          <button 
            onclick="openAddJobModal()" 
            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition flex items-center gap-2"
            title="Add new job manually"
          >
            <i data-lucide="plus" class="w-4 h-4"></i>
            Add Job
          </button>
          <button 
            onclick="refreshJobs()" 
            class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition"
            title="Refresh jobs"
          >
            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
          </button>
          <button 
            onclick="exportJobs()" 
            class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition"
            title="Export jobs"
          >
            <i data-lucide="download" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <!-- Filter Row -->
      <div class="flex flex-wrap items-center gap-2 mb-6">
        <span class="text-sm font-medium text-gray-700">Filter by:</span>
        <button onclick="filterBy('all')" class="filter-chip active" data-filter="all">All Jobs</button>
        <button onclick="filterBy('with-salary')" class="filter-chip" data-filter="with-salary">With Salary</button>
        <button onclick="filterBy('remote')" class="filter-chip" data-filter="remote">Remote</button>
        <button onclick="filterBy('recent')" class="filter-chip" data-filter="recent">Recent</button>
        <button onclick="filterBy('full-time')" class="filter-chip" data-filter="full-time">Full-time</button>
        <button onclick="filterBy('manual')" class="filter-chip" data-filter="manual">Manual Entries</button>
        <div class="ml-auto text-sm text-gray-500">
          Showing <span id="resultCount">0</span> jobs
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="bg-white rounded-2xl shadow">
        <div class="p-6 space-y-4">
          <div class="loading-skeleton h-16"></div>
          <div class="loading-skeleton h-16"></div>
          <div class="loading-skeleton h-16"></div>
        </div>
      </div>

      <!-- Job List -->
      <div id="jobList" class="bg-white rounded-2xl shadow divide-y hidden"></div>

      <!-- Empty State -->
      <div id="emptyState" class="bg-white rounded-2xl shadow p-12 text-center hidden">
        <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
          <i data-lucide="briefcase" class="w-8 h-8 text-gray-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No jobs found</h3>
        <p class="text-gray-500 mb-4">Try adjusting your search, use the "Add Job" button above, or scrape new jobs.</p>
        <a href="/scraper" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
          <i data-lucide="search" class="w-4 h-4 mr-2"></i>
          Scrape Jobs
        </a>
      </div>

      <!-- Pagination -->
      <div class="flex flex-col sm:flex-row justify-between items-center mt-6 gap-4">
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-700">Show</span>
          <select id="pageSizeSelect" class="border border-gray-300 rounded px-2 py-1 text-sm">
            <option value="10" selected>10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
          <span class="text-sm text-gray-700">per page</span>
        </div>
        
        <div class="flex items-center gap-2">
          <button id="prevPage" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed transition">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
          </button>
          <span id="pageInfo" class="text-gray-700 text-sm px-4"></span>
          <button id="nextPage" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed transition">
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
      </div>
    </main>
  </div>



  <!-- Add Job Modal -->
  <div id="addJobModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeAddJobModal()"></div>
    <div class="relative flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="p-6 border-b border-gray-200 sticky top-0 bg-white z-10">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
              <i data-lucide="plus-circle" class="w-5 h-5 text-green-600"></i>
              Add New Job
            </h3>
            <button onclick="closeAddJobModal()" class="p-2 hover:bg-gray-100 rounded-lg transition">
              <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
            </button>
          </div>
        </div>
        
        <!-- Modal Content -->
        <div class="p-6">
          <form id="addJobForm" class="space-y-6">
            <!-- Basic Job Information -->
            <div class="bg-gray-50 rounded-lg p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <i data-lucide="briefcase" class="w-5 h-5 text-indigo-600"></i>
                Basic Job Information
              </h4>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Job Title <span class="text-red-500">*</span>
                  </label>
                  <input 
                    type="text" 
                    name="title" 
                    required 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="e.g. Senior Data Scientist"
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Company <span class="text-red-500">*</span>
                  </label>
                  <input 
                    type="text" 
                    name="company" 
                    required 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="e.g. Tech Solutions Inc."
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Location <span class="text-red-500">*</span>
                  </label>
                  <input 
                    type="text" 
                    name="location" 
                    required 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="e.g. Bengaluru, India or Remote"
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Employment Type
                  </label>
                  <select name="employment_type" class="form-input w-full rounded-lg px-4 py-3">
                    <option value="">Select Type</option>
                    <option value="Full-time">Full-time</option>
                    <option value="Part-time">Part-time</option>
                    <option value="Contract">Contract</option>
                    <option value="Temporary">Temporary</option>
                    <option value="Internship">Internship</option>
                    <option value="Remote">Remote</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Experience Level
                  </label>
                  <select name="seniority_level" class="form-input w-full rounded-lg px-4 py-3">
                    <option value="">Select Level</option>
                    <option value="Internship">Internship</option>
                    <option value="Entry level">Entry Level</option>
                    <option value="Associate">Associate</option>
                    <option value="Mid-Senior level">Mid-Senior Level</option>
                    <option value="Director">Director</option>
                    <option value="Executive">Executive</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Salary Range
                  </label>
                  <input 
                    type="text" 
                    name="salary_range" 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="e.g. ₹8-12 LPA or $80,000-120,000"
                  >
                </div>
              </div>
            </div>

            <!-- Job Description -->
            <div class="bg-gray-50 rounded-lg p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5 text-indigo-600"></i>
                Job Description
              </h4>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Detailed Description <span class="text-red-500">*</span>
                </label>
                <textarea 
                  name="description" 
                  required 
                  rows="8"
                  class="form-input w-full rounded-lg px-4 py-3"
                  placeholder="Provide a detailed job description including responsibilities, requirements, and qualifications..."
                ></textarea>
                <p class="text-xs text-gray-500 mt-1">Use bullet points (•) for better formatting</p>
              </div>
              
              <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Required Skills
                </label>
                <input 
                  type="text" 
                  name="extracted_skills" 
                  class="form-input w-full rounded-lg px-4 py-3"
                  placeholder="e.g. Python, Machine Learning, SQL, React (comma separated)"
                >
                <p class="text-xs text-gray-500 mt-1">Separate skills with commas</p>
              </div>
            </div>

            <!-- Company Information -->
            <div class="bg-gray-50 rounded-lg p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <i data-lucide="building-2" class="w-5 h-5 text-indigo-600"></i>
                Company Information
              </h4>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Company Website
                  </label>
                  <input 
                    type="url" 
                    name="company_url" 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="https://company.com"
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Company Logo URL
                  </label>
                  <input 
                    type="url" 
                    name="company_logo" 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="https://company.com/logo.png"
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Industry
                  </label>
                  <input 
                    type="text" 
                    name="industries" 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="e.g. Technology, Healthcare, Finance"
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Job Function
                  </label>
                  <input 
                    type="text" 
                    name="job_function" 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="e.g. Engineering, Sales, Marketing"
                  >
                </div>
              </div>
              
              <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  About the Company
                </label>
                <textarea 
                  name="company_about" 
                  rows="4"
                  class="form-input w-full rounded-lg px-4 py-3"
                  placeholder="Brief description about the company, its mission, values, and culture..."
                ></textarea>
              </div>
            </div>

            <!-- Additional Information -->
            <div class="bg-gray-50 rounded-lg p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <i data-lucide="info" class="w-5 h-5 text-indigo-600"></i>
                Additional Information
              </h4>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Application URL
                  </label>
                  <input 
                    type="url" 
                    name="job_url" 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="https://company.com/careers/job-id"
                  >
                  <p class="text-xs text-gray-500 mt-1">Where candidates can apply</p>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Posted Date
                  </label>
                  <input 
                    type="date" 
                    name="posted_time" 
                    class="form-input w-full rounded-lg px-4 py-3"
                    value=""
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Applicant Count
                  </label>
                  <input 
                    type="text" 
                    name="applicant_count" 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="e.g. 25 applicants"
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Keywords/Tags
                  </label>
                  <input 
                    type="text" 
                    name="keywords" 
                    class="form-input w-full rounded-lg px-4 py-3"
                    placeholder="e.g. data science, remote, senior"
                  >
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
              <button 
                type="button" 
                onclick="closeAddJobModal()"
                class="px-6 py-3 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition"
              >
                Cancel
              </button>
              <button 
                type="submit"
                class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition flex items-center gap-2"
                id="submitJobBtn"
              >
                <i data-lucide="save" class="w-4 h-4"></i>
                Add Job
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Drawer -->
  <section id="jobDrawer"
    class="drawer fixed right-0 top-0 h-full w-full md:w-[45%] bg-white shadow-2xl transform translate-x-full overflow-y-auto z-20">
    <div class="flex justify-between items-center border-b p-5 bg-gray-50 sticky top-0 z-30">
      <div>
        <h2 id="drawerTitle" class="text-lg font-semibold text-gray-900">Job Details</h2>
        <p id="drawerSubtitle" class="text-sm text-gray-500 mt-1"></p>
      </div>
      <button onclick="closeDrawer()" class="hover:bg-gray-200 p-2 rounded-full transition">
        <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
      </button>
    </div>
    <div id="jobDrawerContent" class="p-8"></div>
  </section>

  <!-- Toast Notifications -->
  <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <script>
    lucide.createIcons();

    let allJobs = [];
    let filteredJobs = [];
    let currentPage = 1;
    let pageSize = 10;
    let currentFilter = 'all';
    let searchTerm = '';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadJobs();
      setupEventListeners();
      
      // Set today's date as default for posted_time
      document.querySelector('input[name="posted_time"]').value = new Date().toISOString().split('T')[0];
    });

    function setupEventListeners() {
      // Search input
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', debounce(handleSearch, 300));
      
      // Page size selector
      document.getElementById('pageSizeSelect').addEventListener('change', function() {
        pageSize = parseInt(this.value);
        currentPage = 1;
        renderJobs();
      });
      
      // Pagination
      document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderJobs();
        }
      });
      
      document.getElementById('nextPage').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredJobs.length / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          renderJobs();
        }
      });

      // Add Job Form
      document.getElementById('addJobForm').addEventListener('submit', handleAddJob);
    }

    async function loadJobs() {
      try {
        showLoadingState();
        const res = await fetch("/api/jobs");
        const data = await res.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to load jobs');
        }
        
        allJobs = data.jobs || [];
        filteredJobs = [...allJobs];
        
        updateSidebarStats();
        renderJobs();
        hideLoadingState();
        showToast('Jobs loaded successfully', 'success');
        
      } catch (error) {
        console.error('Error loading jobs:', error);
        showErrorState();
        showToast('Failed to load jobs', 'error');
      }
    }

    async function handleAddJob(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const jobData = Object.fromEntries(formData.entries());
      
      // Update submit button
      const submitBtn = document.getElementById('submitJobBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div> Saving...';
      submitBtn.disabled = true;
      
      try {
        const response = await fetch('/api/jobs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(jobData)
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to add job');
        }
        
        showToast('Job added successfully!', 'success');
        closeAddJobModal();
        document.getElementById('addJobForm').reset();
        document.querySelector('input[name="posted_time"]').value = new Date().toISOString().split('T')[0];
        
        // Reload jobs to show the new one
        await loadJobs();
        
      } catch (error) {
        console.error('Error adding job:', error);
        showToast(error.message, 'error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    function openAddJobModal() {
      document.getElementById('addJobModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // Focus first input
      setTimeout(() => {
        document.querySelector('input[name="title"]').focus();
      }, 100);
    }

    function closeAddJobModal() {
      document.getElementById('addJobModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function showLoadingState() {
      document.getElementById('loadingState').classList.remove('hidden');
      document.getElementById('jobList').classList.add('hidden');
      document.getElementById('emptyState').classList.add('hidden');
    }

    function hideLoadingState() {
      document.getElementById('loadingState').classList.add('hidden');
    }

    function showErrorState() {
      hideLoadingState();
      document.getElementById('emptyState').classList.remove('hidden');
      document.getElementById('emptyState').querySelector('h3').textContent = 'Failed to load jobs';
      document.getElementById('emptyState').querySelector('p').textContent = 'Please try refreshing the page.';
    }

    function updateSidebarStats() {
      const totalJobs = allJobs.length;
      const uniqueCompanies = new Set(allJobs.map(job => job.company)).size;
      const jobsWithSalary = allJobs.filter(job => 
        job.salary_range && job.salary_range !== 'N/A'
      ).length;
      
      document.getElementById('sidebarTotal').textContent = totalJobs;
      document.getElementById('sidebarCompanies').textContent = uniqueCompanies;
      document.getElementById('sidebarSalary').textContent = jobsWithSalary;
    }

    function handleSearch(event) {
      searchTerm = event.target.value.toLowerCase();
      applyFilters();
    }

    function filterBy(filterType) {
      currentFilter = filterType;
      
      // Update filter chip states
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');
      
      applyFilters();
    }

    function applyFilters() {
      filteredJobs = allJobs.filter(job => {
        // Search filter
        if (searchTerm) {
          const searchableText = [
            job.title,
            job.company,
            job.location,
            job.description,
            job.extracted_skills || ''
          ].join(' ').toLowerCase();
          
          if (!searchableText.includes(searchTerm)) {
            return false;
          }
        }
        
        // Category filter
        switch (currentFilter) {
          case 'with-salary':
            return job.salary_range && job.salary_range !== 'N/A';
          case 'remote':
            return job.location && job.location.toLowerCase().includes('remote');
          case 'recent':
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            return new Date(job.scraped_at) > oneWeekAgo;
          case 'full-time':
            return job.employment_type && job.employment_type.toLowerCase().includes('full');
          case 'manual':
            return job.keywords === 'manual_entry' || !job.scraped_at;
          default:
            return true;
        }
      });
      
      currentPage = 1;
      renderJobs();
    }

    function renderJobs() {
      const jobList = document.getElementById("jobList");
      const resultCount = document.getElementById("resultCount");
      
      resultCount.textContent = filteredJobs.length;
      
      if (filteredJobs.length === 0) {
        jobList.classList.add('hidden');
        document.getElementById('emptyState').classList.remove('hidden');
        return;
      }
      
      document.getElementById('emptyState').classList.add('hidden');
      jobList.classList.remove('hidden');
      
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const jobsToShow = filteredJobs.slice(start, end);
      
      jobList.innerHTML = "";
      
      jobsToShow.forEach(job => {
        const div = document.createElement("div");
        div.className = "job-card p-6 cursor-pointer hover:bg-gray-50 transition";
        
        const timeAgo = getTimeAgo(job.scraped_at);
        const hasSkills = job.extracted_skills && job.extracted_skills !== 'N/A';
        const hasSalary = job.salary_range && job.salary_range !== 'N/A';
        const isManualEntry = job.keywords === 'manual_entry' || !job.scraped_at;
        
        div.innerHTML = `
          <div class="flex items-start gap-4">
            <img src="${job.company_logo || '/static/default-logo.png'}" alt="Logo"
              class="w-12 h-12 rounded object-contain border" onerror="this.src='/static/default-logo.png'"/>
            <div class="flex-1">
              <div class="flex items-start justify-between mb-2">
                <div>
                  <h3 class="font-semibold text-gray-900 text-lg flex items-center gap-2">
                    ${job.title}
                    ${isManualEntry ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-medium">Manual</span>' : ''}
                  </h3>
                  <p class="text-gray-700">${job.company}</p>
                  <p class="text-sm text-gray-500 mt-1">
                    <i data-lucide="map-pin" class="w-3 h-3 inline mr-1"></i>
                    ${job.location || "N/A"} • 
                    <i data-lucide="clock" class="w-3 h-3 inline mr-1 ml-2"></i>
                    ${timeAgo}
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1">
                  <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-medium">
                    ${job.employment_type || "N/A"}
                  </span>
                  ${hasSalary ? `<span class="salary-badge">${job.salary_range}</span>` : ''}
                </div>
              </div>
              
              ${hasSkills ? `
              <div class="flex flex-wrap gap-1 mb-2">
                ${job.extracted_skills.split(',').slice(0, 3).map(skill => 
                  `<span class="skill-tag text-xs">${skill.trim()}</span>`
                ).join('')}
                ${job.extracted_skills.split(',').length > 3 ? 
                  `<span class="text-xs text-gray-500 py-1">+${job.extracted_skills.split(',').length - 3} more</span>` : ''
                }
              </div>
              ` : ''}
              
              <p class="text-sm text-gray-600 line-clamp-2">
                ${truncateText(job.description || 'No description available', 120)}
              </p>
            </div>
          </div>
        `;
        
        div.addEventListener("click", () => openDrawer(job));
        jobList.appendChild(div);
      });

      updatePagination();
      lucide.createIcons();
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredJobs.length / pageSize);
      document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById("prevPage").disabled = currentPage === 1;
      document.getElementById("nextPage").disabled = currentPage === totalPages;
    }

    function formatJobDescription(description) {
      if (!description || description === "No description available.") {
        return description;
      }
      
      // Split into sentences and paragraphs
      let formatted = description
        .replace(/\s+/g, ' ') // Normalize whitespace
        .trim();
      
      // More intelligent bullet point detection
      // Only treat as bullet points if they start a new line or follow significant whitespace
      // and are followed by a space and then text
      formatted = formatted.replace(/(\n|^|\.\s+)([·•\-\*])\s+([A-Z])/g, '$1\n• $3');
      
      // Handle numbered lists
      formatted = formatted.replace(/(\n|^|\.\s+)(\d+\.)\s+([A-Z])/g, '$1\n$2 $3');
      
      // Add line breaks before common section headers (case insensitive)
      const sectionHeaders = [
        'About the job:', 'About the role:', 'About the company:', 'About us:',
        'Job Summary:', 'Role Summary:', 'Position Summary:',
        'Responsibilities:', 'Key Responsibilities:', 'Main Responsibilities:',
        'Requirements:', 'Job Requirements:', 'Key Requirements:',
        'Qualifications:', 'Required Qualifications:', 'Preferred Qualifications:',
        'Skills:', 'Required Skills:', 'Technical Skills:', 'Key Skills:',
        'Experience:', 'Required Experience:', 'Work Experience:',
        'Education:', 'Educational Requirements:', 'Educational Background:',
        'What you\'ll do:', 'What we\'re looking for:', 'What you bring:',
        'Nice to have:', 'Preferred:', 'Bonus points:', 'Plus:',
        'Benefits:', 'What we offer:', 'Compensation:', 'Package:',
        'Location:', 'Work arrangement:', 'Employment type:',
        'Roles & Responsibilities:', 'Job Specifications:', 'Main Interfaces:',
        'Mission:', 'Vision:', 'Values:', 'About Danone Group:', 'About Danone India:'
      ];
      
      sectionHeaders.forEach(header => {
        const escapedHeader = header.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`\\b(${escapedHeader})`, 'gi');
        formatted = formatted.replace(regex, '\n\n**$1**');
      });
      
      // Format degree requirements and years of experience
      formatted = formatted.replace(/\b(Bachelor's|Master's|PhD|Degree in|B\.A\.|B\.S\.|M\.A\.|M\.S\.|Ph\.D\.)/gi, '\n\n**$1');
      formatted = formatted.replace(/\b(\d+\+?\s*years?\s+of\s+experience)/gi, '\n\n**$1**');
      
      // Convert list items that appear to be separate lines into bullet points
      // Look for lines that start with a capital letter after periods or section breaks
      const lines = formatted.split('\n');
      const processedLines = [];
      let inListSection = false;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // Check if we're in a responsibilities or requirements section
        if (line.includes('**Responsibilities:**') || line.includes('**Requirements:**') || 
            line.includes('**Qualifications:**') || line.includes('**Skills:**') ||
            line.includes('**Job Specifications:**') || line.includes('**Main Interfaces**')) {
          inListSection = true;
          processedLines.push(line);
          continue;
        }
        
        // Check if we're starting a new section
        if (line.startsWith('**') && line.endsWith('**')) {
          inListSection = false;
          processedLines.push(line);
          continue;
        }
        
        // If we're in a list section and the line looks like a list item
        if (inListSection && line && !line.startsWith('•') && !line.startsWith('**')) {
          // Add bullet point if it's a substantial line
          if (line.length > 10 && /^[A-Z]/.test(line)) {
            processedLines.push('• ' + line);
          } else {
            processedLines.push(line);
          }
        } else {
          processedLines.push(line);
        }
      }
      
      formatted = processedLines.join('\n');
      
      // Split into paragraphs and format
      const paragraphs = formatted.split('\n').filter(p => p.trim());
      
      return paragraphs.map(paragraph => {
        const trimmed = paragraph.trim();
        
        // Skip empty paragraphs
        if (!trimmed) return '';
        
        // Format headers (bold text)
        if (trimmed.startsWith('**') && trimmed.endsWith('**')) {
          return `<div class="font-semibold text-gray-900 mt-4 mb-2 text-base border-l-4 border-indigo-500 pl-3">${trimmed.slice(2, -2)}</div>`;
        }
        
        // Format numbered lists
        if (/^\d+\.\s/.test(trimmed)) {
          return `<div class="flex items-start gap-2 mb-2">
            <span class="text-indigo-600 font-semibold mt-1 min-w-[1.5rem]">${trimmed.match(/^\d+\./)[0]}</span>
            <span class="flex-1">${trimmed.replace(/^\d+\.\s/, '')}</span>
          </div>`;
        }
        
        // Format bullet points
        if (trimmed.startsWith('•')) {
          return `<div class="flex items-start gap-2 mb-2">
            <span class="text-indigo-500 font-bold mt-1 min-w-[1rem]">•</span>
            <span class="flex-1">${trimmed.slice(1).trim()}</span>
          </div>`;
        }
        
        // Format company/section descriptions (longer paragraphs)
        if (trimmed.length > 100) {
          return `<div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-300 rounded-r-lg">
            <p class="leading-relaxed text-gray-700">${trimmed}</p>
          </div>`;
        }
        
        // Regular paragraphs
        return `<p class="mb-3 leading-relaxed">${trimmed}</p>`;
      }).join('');
    }

    function openDrawer(job) {
      const drawer = document.getElementById("jobDrawer");
      const content = document.getElementById("jobDrawerContent");
      const title = document.getElementById("drawerTitle");
      const subtitle = document.getElementById("drawerSubtitle");
      
      const skills = job.extracted_skills && job.extracted_skills !== 'N/A' 
        ? job.extracted_skills.split(',').map(s => s.trim())
        : [];
      
      const isManualEntry = job.keywords === 'manual_entry' || !job.scraped_at;

      drawer.classList.remove("translate-x-full");
      title.textContent = job.title;
      subtitle.textContent = `${job.company} • ${job.location || 'Remote'}`;

      content.innerHTML = `
        <div class="max-w-3xl mx-auto space-y-8">
          <div class="flex items-start gap-4">
            <img src="${job.company_logo || '/static/default-logo.png'}" alt="Logo"
              class="w-16 h-16 rounded object-contain border" onerror="this.src='/static/default-logo.png'"/>
            <div class="flex-1">
              <h1 class="text-2xl font-bold text-gray-900 mb-1 flex items-center gap-2">
                ${job.title}
                ${isManualEntry ? '<span class="text-sm bg-green-100 text-green-700 px-3 py-1 rounded-full font-medium">Manual Entry</span>' : ''}
              </h1>
              <p class="text-lg text-gray-700">${job.company}</p>
              <p class="text-sm text-gray-500">${job.location || "N/A"} • ${job.posted_time || ""}</p>
            </div>
          </div>

          <div class="bg-gray-50 rounded-lg p-4 grid grid-cols-2 gap-3 text-sm text-gray-700">
            <p><span class="font-medium">Employment Type:</span> ${job.employment_type || "N/A"}</p>
            <p><span class="font-medium">Seniority Level:</span> ${job.seniority_level || "N/A"}</p>
            <p><span class="font-medium">Job Function:</span> ${job.job_function || "N/A"}</p>
            <p><span class="font-medium">Industries:</span> ${job.industries || "N/A"}</p>
            ${job.salary_range && job.salary_range !== 'N/A' ? `
            <p><span class="font-medium">Salary Range:</span> <span class="text-green-600 font-semibold">${job.salary_range}</span></p>
            ` : ''}
            ${job.applicant_count && job.applicant_count !== 'N/A' ? `
            <p><span class="font-medium">Applicants:</span> ${job.applicant_count}</p>
            ` : ''}
            <p><span class="font-medium">Added:</span> ${job.scraped_at ? new Date(job.scraped_at).toLocaleString() : 'Manual entry'}</p>
            <p><span class="font-medium">Keywords:</span> ${job.keywords === 'manual_entry' ? 'Manual Entry' : job.keywords || "N/A"}</p>
          </div>

          ${skills.length ? `
          <div>
            <div class="flex items-center gap-2 mb-3">
              <i data-lucide="code" class="w-4 h-4"></i>
              <span class="font-semibold text-gray-800">Skills Required</span>
            </div>
            <div class="flex flex-wrap gap-2">
              ${skills.map(s => `<span class="skill-tag">${s}</span>`).join('')}
            </div>
          </div>` : ''}

          <div>
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="file-text" class="w-4 h-4"></i>
              <span class="font-semibold text-gray-800">Job Description</span>
            </div>
            <div class="job-description text-gray-700 leading-relaxed border rounded-lg p-4 bg-gray-50 text-sm max-h-64 overflow-y-auto">
              ${formatJobDescription(job.description || "No description available.")}
            </div>
          </div>

          ${job.company_about || job.company_url || job.company_stats ? `
          <div class="border-t pt-4">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="building-2" class="w-4 h-4"></i>
              <span class="font-semibold text-gray-800">About ${job.company}</span>
            </div>
            <div class="text-gray-700 leading-relaxed bg-gray-50 border rounded-lg p-4">
              ${job.company_about || "No company details available."}
            </div>
            ${job.company_stats ? `<p class="text-sm text-gray-500 mt-2">${job.company_stats}</p>` : ""}
            ${job.company_url ? `<a href="${job.company_url}" target="_blank" class="inline-flex items-center gap-1 mt-3 text-indigo-600 hover:underline text-sm"><i data-lucide="external-link" class="w-4 h-4"></i> Company Profile</a>` : ""}
          </div>` : ''}

          <div class="border-t pt-4 flex gap-3">
            ${job.job_url ? `
            <a href="${job.job_url}" target="_blank" class="flex-1 inline-flex justify-center items-center gap-2 bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
              <i data-lucide="external-link" class="w-4 h-4"></i> Apply Now
            </a>
            ` : `
            <div class="flex-1 inline-flex justify-center items-center gap-2 bg-gray-300 text-gray-500 px-4 py-3 rounded-lg text-sm font-medium cursor-not-allowed">
              <i data-lucide="link-off" class="w-4 h-4"></i> No Application Link
            </div>
            `}
            <button onclick="shareJob('${job.job_url || '#'}', '${job.title}', '${job.company}')" class="px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
              <i data-lucide="share-2" class="w-4 h-4"></i>
            </button>
          </div>
        </div>`;
      
      document.body.style.overflow = 'hidden';
      lucide.createIcons();
    }

    function closeDrawer() {
      document.getElementById("jobDrawer").classList.add("translate-x-full");
      document.body.style.overflow = 'auto';
    }

    function shareJob(url, title, company) {
      if (navigator.share) {
        navigator.share({
          title: title,
          text: `Check out this job at ${company}`,
          url: url
        });
      } else {
        navigator.clipboard.writeText(url || window.location.href);
        showToast('Job link copied to clipboard!', 'success');
      }
    }

    async function refreshJobs() {
      await loadJobs();
    }

    function exportJobs() {
      try {
        const csvContent = convertToCSV(filteredJobs);
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `jobs_export_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showToast('Jobs exported successfully!', 'success');
      } catch (error) {
        showToast('Failed to export jobs', 'error');
      }
    }

    function convertToCSV(jobs) {
      const headers = ['Title', 'Company', 'Location', 'Employment Type', 'Salary Range', 'Skills', 'Job URL', 'Source'];
      const rows = jobs.map(job => [
        job.title,
        job.company,
        job.location,
        job.employment_type,
        job.salary_range || '',
        job.extracted_skills || '',
        job.job_url || '',
        job.keywords === 'manual_entry' ? 'Manual' : 'Scraped'
      ]);
      
      return [headers, ...rows]
        .map(row => row.map(field => `"${(field || '').replace(/"/g, '""')}"`).join(','))
        .join('\n');
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const bgColor = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
      }[type] || 'bg-blue-500';
      
      toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg text-sm font-medium transform translate-x-0 transition-all duration-300`;
      toast.textContent = message;
      
      document.getElementById('toastContainer').appendChild(toast);
      
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function getTimeAgo(dateString) {
      if (!dateString) return 'Just added';
      
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
      return `${Math.floor(diffDays / 30)} months ago`;
    }

    function truncateText(text, maxLength) {
      if (!text || text.length <= maxLength) return text;
      return text.substr(0, maxLength) + '...';
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeDrawer();
        closeAddJobModal();
      }
      if (e.key === '/' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
      }
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        openAddJobModal();
      }
    });

    // Initialize
    loadJobs();
  </script>
</body>
</html>